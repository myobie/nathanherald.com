<!DOCTYPE html>
<html>
  <head lang="en-us">
    <meta content="HTML Tidy for HTML5 for Apple macOS version 5.8.0" name="generator">
    <meta charset="UTF-8">
    <title>
      I'm Nathan Herald ‚Üí Server-side DOM serialization with a weather app example
    </title>
    <script>
      if ((new URL(window.location.href)).host === 'myobie.com') { window.location.assign('https://nathanherald.com') }
    </script>
    <link href="https://cloud.typography.com/6836312/761366/css/fonts.css" rel="stylesheet" type=
    "text/css">
    <link href="/styles.css" rel="stylesheet" type="text/css">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="I'm Nathan Herald ‚Üí Server-side DOM serialization with a weather app example"
    name="title">
    <meta content=
    "A practical demonstration of server-side DOM serialization using custom elements, built with Bun, Deno, and Cloudflare Workers"
    name="description">
    <meta content="Server-side DOM serialization with a weather app example" property="og:title">
    <meta content="website" property="og:type">
    <meta content=
    "A practical demonstration of server-side DOM serialization using custom elements, built with Bun, Deno, and Cloudflare Workers"
    property="og:description">
    <meta content="/og.png" property="og:image">
    <meta content="I'm Nathan Herald" property="og:site_name">
    <link href="/rss.xml" rel="alternate" title="Feed of all the posts on nathanherald.com" type=
    "application/rss+xml">
  </head>
  <body class="default">
    <header class="section-header">
      <div class="section-nav">
        <h1 class="home-link">
          <a class="never-underline" data-nospan="" href="/"><abbr title="Hello">üëã</abbr></a>
          <a href="/">I'm Nathan</a>
        </h1>
        <nav>
          <p>
            Find more in the <a href="/posts/">archive of all the posts on this site</a> or
            <a href="/rss.xml">subscribe with RSS</a>.
          </p>
        </nav>
      </div>
    </header>
    <main class="single">
      <article>
        <header>
          <h1>
            Server-side DOM serialization with a weather app example
          </h1>
        </header>
        <div class="content">
          <p>
            After exploring <a href="/posts/web-components-4/">server-side rendering and DOM
            serialization</a> in my Web Components series, I wanted to build a practical example
            that demonstrates these concepts in action. The result is a weather app that showcases
            server-side DOM serialization across multiple JavaScript runtimes.
          </p>
          <p>
            ‚û°Ô∏è <strong><a href="https://weather.myobie.wtf/">See it live at
            weather.myobie.wtf</a></strong> | <strong><a href=
            "https://github.com/myobie/serialized-weather">View source on GitHub</a></strong>
          </p>
          <p>
            <em>Questions about the implementation? <a href="https://indieweb.social/@myobie">Find
            me on Mastodon</a> to discuss!</em>
          </p>
          <h2 id="the-core-idea">
            The Core Idea
          </h2>
          <p>
            This weather app demonstrates building a DOM on the server, serializing it, and sending
            it back as the initial HTML response. The same DOM gets deserialized and becomes fully
            interactive in the browser using the exact same custom elements and JavaScript code.
          </p>
          <p>
            The magic happens with <a href=
            "https://github.com/WebReflection/linkedom"><code>linkedom</code></a>, which acts as a
            server-side DOM implementation. Here's the basic flow:
          </p>
          <div class="sourceCode" id="cb1">
            <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id=
            "cb1-1"><a aria-hidden="true" href="#cb1-1" tabindex="-1"></a><span class=
            "im">import</span> { parseHTML } <span class="im">from</span> <span class=
            "st">'linkedom'</span></span>
<span id="cb1-2"><a aria-hidden="true" href="#cb1-2" tabindex="-1"></a><span class=
"im">import</span> { serializeAsync } <span class="im">from</span> <span class=
"st">'./serialize.ts'</span></span>
<span id="cb1-3"><a aria-hidden="true" href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a aria-hidden="true" href="#cb1-4" tabindex="-1"></a><span class=
"co">// Create a server-side DOM</span></span>
<span id="cb1-5"><a aria-hidden="true" href="#cb1-5" tabindex="-1"></a><span class=
"kw">const</span> { <span class="bu">document</span><span class=
"op">,</span> customElements } <span class="op">=</span> <span class=
"fu">parseHTML</span>(<span class="vs">`</span></span>
<span id="cb1-6"><a aria-hidden="true" href="#cb1-6" tabindex="-1"></a><span class=
"vs">  &lt;!doctype html&gt;</span></span>
<span id="cb1-7"><a aria-hidden="true" href="#cb1-7" tabindex="-1"></a><span class=
"vs">  &lt;html&gt;&lt;body&gt;</span></span>
<span id="cb1-8"><a aria-hidden="true" href="#cb1-8" tabindex="-1"></a><span class=
"vs">    &lt;weather-app latitude="52.5" longitude="13.4"&gt;&lt;/weather-app&gt;</span></span>
<span id="cb1-9"><a aria-hidden="true" href="#cb1-9" tabindex="-1"></a><span class=
"vs">  &lt;/body&gt;&lt;/html&gt;</span></span>
<span id="cb1-10"><a aria-hidden="true" href="#cb1-10" tabindex="-1"></a><span class=
"vs">`</span>)</span>
<span id="cb1-11"><a aria-hidden="true" href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a aria-hidden="true" href="#cb1-12" tabindex="-1"></a><span class=
"co">// Define your custom elements on the server</span></span>
<span id="cb1-13"><a aria-hidden="true" href="#cb1-13" tabindex="-1"></a>customElements<span class=
"op">.</span><span class="fu">define</span>(<span class="st">'weather-app'</span><span class=
"op">,</span> WeatherAppElement)</span>
<span id="cb1-14"><a aria-hidden="true" href="#cb1-14" tabindex="-1"></a></span>
<span id="cb1-15"><a aria-hidden="true" href="#cb1-15" tabindex="-1"></a><span class=
"co">// Let elements render and fetch data</span></span>
<span id="cb1-16"><a aria-hidden="true" href="#cb1-16" tabindex="-1"></a><span class=
"cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class=
"kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class=
"dv">100</span>))</span>
<span id="cb1-17"><a aria-hidden="true" href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a aria-hidden="true" href="#cb1-18" tabindex="-1"></a><span class=
"co">// Serialize the fully-rendered DOM</span></span>
<span id="cb1-19"><a aria-hidden="true" href="#cb1-19" tabindex="-1"></a><span class=
"kw">const</span> html <span class="op">=</span> <span class="cf">await</span> <span class=
"fu">serializeAsync</span>(<span class="bu">document</span><span class="op">.</span><span class=
"at">documentElement</span>)</span>
<span id="cb1-20"><a aria-hidden="true" href="#cb1-20" tabindex="-1"></a><span class=
"cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(<span class=
"vs">`&lt;!doctype html&gt;</span><span class="sc">${</span>html<span class=
"sc">}</span><span class="vs">`</span>)</span></code></pre>
          </div>
          <p>
            The key insight is that you must define your custom elements in both environments: once
            on the server using linkedom's <code>customElements</code> registry, and again in the
            browser using the native <code>customElements</code>. For 99% of my custom element
            code, linkedom requires no changes from what works in browsers‚Äîit's like having another
            browser target for your components.
          </p>
          <h2 id="progressive-enhancement-in-action">
            Progressive Enhancement in Action
          </h2>
          <p>
            The app implements true progressive enhancement with intelligent fallbacks:
          </p>
          <ul>
            <li>
              <strong>Server-side rendering</strong>: Custom elements run on the server and
              serialize their initial state
            </li>
            <li>
              <strong>Timeout protection</strong>: If server requests take too long, the page
              renders immediately
            </li>
            <li>
              <strong>Client-side recovery</strong>: The browser takes over and retries any failed
              server requests
            </li>
            <li>
              <strong>Graceful degradation</strong>: Works as either a pure SPA or pure
              server-rendered app
            </li>
          </ul>
          <p>
            This approach ensures users always get a functional experience, regardless of network
            conditions or server performance.
          </p>
          <h2 id="multi-runtime-implementation">
            Multi-Runtime Implementation
          </h2>
          <p>
            The repository demonstrates the same serialization approach across different
            environments:
          </p>
          <h3 id="deno-implementation">
            Deno Implementation
          </h3>
          <p>
            Uses import maps and native fetch for a clean, standards-based approach. The <a href=
            "https://github.com/myobie/serialized-weather/tree/main/deno">Deno version</a> shows
            how modern JavaScript runtimes can handle server-side custom elements elegantly.
          </p>
          <h3 id="bun-implementation">
            Bun Implementation
          </h3>
          <p>
            The <a href="https://github.com/myobie/serialized-weather/tree/main/bun">Bun
            implementation</a> leverages Bun's speed and Node.js compatibility while maintaining
            the same serialization patterns. Demonstrates how the approach scales across different
            runtime performance characteristics.
          </p>
          <h3 id="cloudflare-worker">
            Cloudflare Worker
          </h3>
          <p>
            The <a href="https://github.com/myobie/serialized-weather/tree/main/worker">Worker
            version</a> runs at the edge with sub-100ms response times. Here's how it sets up
            server-side rendering:
          </p>
          <div class="sourceCode" id="cb2">
            <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id=
            "cb2-1"><a aria-hidden="true" href="#cb2-1" tabindex="-1"></a><span class=
            "kw">const</span> linkie <span class="op">=</span> <span class=
            "fu">parseHTML</span>(code<span class="op">,</span> {</span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2" tabindex="-1"></a>  <span class=
"dt">location</span><span class="op">:</span> url<span class="op">,</span></span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3" tabindex="-1"></a>  <span class=
"dt">isServer</span><span class="op">:</span> <span class="kw">true</span><span class=
"op">,</span></span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4" tabindex="-1"></a>  <span class=
"dt">cfGeo</span><span class="op">:</span> { <span class="dt">latitude</span><span class=
"op">:</span> request<span class="op">.</span><span class="at">cf</span><span class=
"op">?.</span><span class="at">latitude</span><span class="op">,</span> longitude<span class=
"op">:</span> request<span class="op">.</span><span class="at">cf</span><span class=
"op">?.</span><span class="at">longitude</span><span class="op">,</span> nearbyName }<span class=
"op">,</span></span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5" tabindex="-1"></a>})<span class=
"op">;</span></span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7" tabindex="-1"></a><span class=
"co">// Define custom elements on the server</span></span>
<span id="cb2-8"><a aria-hidden="true" href="#cb2-8" tabindex="-1"></a><span class=
"kw">const</span> KEnvContextElement <span class="op">=</span> <span class=
"kw">class</span> <span class="kw">extends</span> EnvContextElement {}<span class=
"op">;</span></span>
<span id="cb2-9"><a aria-hidden="true" href="#cb2-9" tabindex="-1"></a>linkie<span class=
"op">.</span><span class="at">customElements</span><span class="op">.</span><span class=
"fu">define</span>(KEnvContextElement<span class="op">.</span><span class=
"at">defaultName</span><span class="op">,</span> KEnvContextElement)<span class=
"op">;</span></span>
<span id="cb2-10"><a aria-hidden="true" href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a aria-hidden="true" href="#cb2-11" tabindex="-1"></a><span class=
"co">// Serialize the rendered DOM</span></span>
<span id="cb2-12"><a aria-hidden="true" href="#cb2-12" tabindex="-1"></a><span class=
"kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class=
"fu">serializeAsync</span>(linkie<span class="op">.</span><span class=
"at">document</span><span class="op">.</span><span class="at">documentElement</span>)<span class=
"op">;</span></span>
<span id="cb2-13"><a aria-hidden="true" href="#cb2-13" tabindex="-1"></a><span class=
"cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(<span class=
"vs">`&lt;!doctype html&gt;</span><span class="sc">${</span>result<span class=
"sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb2-14"><a aria-hidden="true" href="#cb2-14" tabindex="-1"></a>  <span class=
"dt">headers</span><span class="op">:</span> { <span class="st">'content-type'</span><span class=
"op">:</span> <span class="st">'text/html'</span> }<span class="op">,</span></span>
<span id="cb2-15"><a aria-hidden="true" href="#cb2-15" tabindex="-1"></a>})<span class=
"op">;</span></span></code></pre>
          </div>
          <h3 id="specialized-variants">
            Specialized Variants
          </h3>
          <ul>
            <li>
              <strong><a href=
              "https://github.com/myobie/serialized-weather/tree/main/deno-client-only">Client-only
              version</a></strong>: Pure SPA by skipping server-side element registration
            </li>
            <li>
              <strong><a href=
              "https://github.com/myobie/serialized-weather/tree/main/deno-server-only">Server-only
              version</a></strong>: Traditional server-rendered app without client-side JavaScript
            </li>
          </ul>
          <h2 id="technical-challenges-and-solutions">
            Technical Challenges and Solutions
          </h2>
          <p>
            The main hurdle with server-side custom elements is that they must inherit from
            <code>HTMLElement</code>, which normally only exists in browsers. Here's how the
            weather app solves this:
          </p>
          <h3 id="isomorphic-htmlelement-handling">
            Isomorphic HTMLElement Handling
          </h3>
          <p>
            The key insight is creating environment-specific DOM exports. On the server, we use
            linkedom's <code>HTMLElement</code>:
          </p>
          <div class="sourceCode" id="cb3">
            <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id=
            "cb3-1"><a aria-hidden="true" href="#cb3-1" tabindex="-1"></a><span class=
            "co">// linkedom-dom.ts (server)</span></span>
<span id="cb3-2"><a aria-hidden="true" href="#cb3-2" tabindex="-1"></a><span class=
"im">import</span> { parseHTML } <span class="im">from</span> <span class=
"st">'npm:linkedom'</span></span>
<span id="cb3-3"><a aria-hidden="true" href="#cb3-3" tabindex="-1"></a><span class=
"kw">const</span> doc <span class="op">=</span> <span class="fu">parseHTML</span>(<span class=
"st">'&lt;!doctype html&gt;&lt;div&gt;&lt;/div&gt;'</span>)</span>
<span id="cb3-4"><a aria-hidden="true" href="#cb3-4" tabindex="-1"></a><span class=
"im">export</span> <span class="kw">const</span> { customElements<span class=
"op">,</span> <span class="bu">Event</span><span class="op">,</span> <span class=
"bu">HTMLElement</span> } <span class="op">=</span> doc</span></code></pre>
          </div>
          <p>
            While in the browser, we use the native <code>HTMLElement</code>:
          </p>
          <div class="sourceCode" id="cb4">
            <pre class="sourceCode javascript"><code class="sourceCode javascript"><span id=
            "cb4-1"><a aria-hidden="true" href="#cb4-1" tabindex="-1"></a><span class=
            "co">// browser-dom.js (client)</span></span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2" tabindex="-1"></a><span class=
"kw">const</span> c <span class="op">=</span> globalThis<span class="op">.</span><span class=
"at">customElements</span></span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3" tabindex="-1"></a><span class=
"kw">const</span> <span class="cn">E</span> <span class="op">=</span> <span class=
"bu">Event</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4" tabindex="-1"></a><span class=
"kw">const</span> HE <span class="op">=</span> <span class="bu">HTMLElement</span></span>
<span id="cb4-5"><a aria-hidden="true" href="#cb4-5" tabindex="-1"></a><span class=
"im">export</span> { c <span class="im">as</span> customElements<span class=
"op">,</span> <span class="cn">E</span> <span class="im">as</span> <span class=
"bu">Event</span><span class="op">,</span> HE <span class="im">as</span> <span class=
"bu">HTMLElement</span> }</span></code></pre>
          </div>
          <p>
            <a href=
            "https://github.com/myobie/serialized-weather/blob/main/deno/linkedom-dom.ts">View the
            complete isomorphic setup ‚Üí</a>
          </p>
          <h3 id="custom-serialization-strategy">
            Custom Serialization Strategy
          </h3>
          <p>
            The app includes <a href=
            "https://github.com/myobie/serialized-weather/blob/main/deno/serialize.ts">a custom
            async serializer</a> that handles:
          </p>
          <ul>
            <li>
              <strong>Element lifecycle management</strong>: Waits for custom elements to be
              "ready" before serializing
            </li>
            <li>
              <strong>Attribute handling</strong>: Sorts attributes for consistent output
            </li>
            <li>
              <strong>Timeout protection</strong>: Prevents slow elements from blocking the entire
              response
            </li>
            <li>
              <strong>Shadow DOM avoidance</strong>: Intentionally keeps serialization simple by
              avoiding shadow DOM complexity
            </li>
          </ul>
          <p>
            This approach ensures that server-rendered custom elements maintain their state when
            the page loads in the browser.
          </p>
          <h2 id="building-on-previous-work">
            Building on Previous Work
          </h2>
          <p>
            This weather app serves as the practical companion to the theoretical foundations I
            laid out in <a href="/posts/web-components-4/">Web Components Part 4</a>. Where that
            post explored the concepts and research behind server-side custom element
            serialization, this project shows those ideas implemented across real deployment
            scenarios.
          </p>
          <p>
            The combination of both posts provides a complete picture: the research and theory,
            followed by production-ready implementations that you can run and deploy today.
          </p>
          <hr>
          <p>
            <em>Try the <a href="https://weather.myobie.wtf/">live demo</a> and explore the
            <a href="https://github.com/myobie/serialized-weather">source code</a> to see
            server-side DOM serialization in action.</em>
          </p>
        </div>
        <footer>
          <p>
            Posted on <time datetime="2025-09-01T12:00:00+02:00">2025-09-01T12:00:00+02:00</time>
          </p>
        </footer>
      </article>
    </main>
    <script async src="/behavior.js"></script> 
    <script async src="/assets/details-controls.js"></script> 
    <script data-domain="nathanherald.com" defer src="https://stats.myobie.wtf/script.js"></script>
  </body>
</html>
